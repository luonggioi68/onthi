<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITI AI Vision - Giải Bài Tập Thông Minh</title>
    
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root { --primary: #4A90E2; --success: #2ecc71; --dark: #2c3e50; }
        body { margin: 0; background: #000; font-family: 'Segoe UI', Tahoma, sans-serif; height: 100vh; overflow: hidden; }
        
        /* Giao diện Camera & Cropper */
        #camera-section, #crop-section { position: relative; width: 100%; height: 80vh; background: #000; }
        video, #image-to-crop { width: 100%; height: 100%; object-fit: cover; }
        
        .controls {
            position: fixed; bottom: 0; width: 100%; height: 20vh;
            background: #fff; border-radius: 25px 25px 0 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }

        .btn-snap {
            width: 70px; height: 70px; border-radius: 50%; border: 5px solid #eee;
            background: var(--primary); cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Vùng hiển thị kết quả Markdown */
        #result-area {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; display: none; z-index: 2000; overflow-y: auto; padding: 25px; box-sizing: border-box;
        }
        #ai-solution { line-height: 1.7; font-size: 16px; color: var(--dark); }
        #ai-solution h1, #ai-solution h2, #ai-solution h3 { color: var(--primary); }
        #ai-solution code { background: #f4f4f4; padding: 2px 5px; border-radius: 4px; }
        
        /* Màn hình chờ */
        .loader {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); color: #fff; z-index: 3000;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="camera-section">
    <video id="video" autoplay playsinline muted></video>
    <div class="controls">
        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Chụp ảnh nội dung cần giải</p>
        <button class="btn-snap" id="snapBtn"></button>
    </div>
</div>

<div id="crop-section" style="display:none;">
    <img id="image-to-crop">
    <div class="controls">
        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">Cắt vùng chứa câu hỏi</p>
        <div style="display: flex; gap: 15px;">
            <button onclick="location.reload()" style="padding: 10px 20px; border-radius: 10px; border: 1px solid #ccc; background: #fff;">Chụp lại</button>
            <button id="confirmBtn" style="padding: 10px 20px; border-radius: 10px; background: var(--success); color: #fff; border: none; font-weight: bold;">Giải ngay</button>
        </div>
    </div>
</div>

<div id="result-area">
    <button onclick="location.reload()" style="float: right; padding: 8px 15px; background: #f1f1f1; border: none; border-radius: 8px;">Đóng X</button>
    <h2 style="color: var(--primary);">Lời giải từ TITI AI:</h2>
    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
    <div id="ai-solution"></div>
</div>

<div class="loader" id="loader"><div class="spinner"></div><p style="margin-top:15px;">TITI đang xử lý...</p></div>
<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const imageToCrop = document.getElementById('image-to-crop');
    const cameraSection = document.getElementById('camera-section');
    const cropSection = document.getElementById('crop-section');
    let cropper;

    // Khởi động Camera
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
            });
            video.srcObject = stream;
        } catch (e) { alert("Lỗi camera. Hãy cấp quyền truy cập!"); }
    }

    // Chụp ảnh để chuẩn bị cắt
    document.getElementById('snapBtn').onclick = () => {
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        imageToCrop.src = canvas.toDataURL('image/jpeg');
        cameraSection.style.display = 'none';
        cropSection.style.display = 'block';

        cropper = new Cropper(imageToCrop, { viewMode: 1, autoCropArea: 0.8 });
    };

    // Gửi ảnh đã cắt cho AI Vision
    document.getElementById('confirmBtn').onclick = async () => {
        const croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 1024, maxHeight: 1024 });
        const base64Image = croppedCanvas.toDataURL('image/jpeg', 0.8);
        document.getElementById('loader').style.display = 'flex';

        try {
            const res = await fetch('/api/solve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64Image })
            });
            const data = await res.json();
            
            // Render Markdown & MathJax
            const solDiv = document.getElementById('ai-solution');
            solDiv.innerHTML = marked.parse(data.solution); // Chuyển Markdown sang HTML
            document.getElementById('result-area').style.display = 'block';
            
            if (window.MathJax) MathJax.typesetPromise(); // Vẽ công thức toán
        } catch (e) { alert("Lỗi kết nối AI!"); }
        finally { document.getElementById('loader').style.display = 'none'; }
    };

    startCamera();
</script>
</body>
</html>
